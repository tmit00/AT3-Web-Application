<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}My Application{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>

    {% block extra_head %}{% endblock %}
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>FocusFlow</h2>
            <div class="sidebar-subtitle">Productivity Suite</div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="{{ url_for('dashboard') }}" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('calendar_routes.calendar_server') }}" class="nav-link">
                        <span class="nav-icon">üìÖ</span>
                        <span class="nav-text">Calendar</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('todo_routes.pomodoro') }}" class="nav-link">
                        <span class="nav-icon">‚è±Ô∏è</span>
                        <span class="nav-text">Pomodoro Timer</span>
                        <span class="nav-badge">Focus</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('todo_routes.chatbot') }}" class="nav-link">
                        <span class="nav-icon">ü§ñ</span>
                        <span class="nav-text">AI Assistant</span>
                        <span class="nav-badge">New</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="logout-container">
                <a href="{{ url_for('logout') }}" class="logout-button">
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </div>
    <div class="main-content">
        <!-- Mobile menu toggle button -->
        <button id="mobile-menu-toggle" class="mobile-menu-toggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        {% block content %}{% endblock %}
    </div>
    {% if not hide_mini_timer %}
    <!-- Popout Pomodoro Timer -->
    <div id="popout-pomodoro-timer" style="display:none;">
        <div class="popout-header">
            <div class="popout-drag-handle">‚ãÆ‚ãÆ</div>
            <div class="popout-controls">
                <button id="popout-minimize-btn" class="popout-control-btn">‚àí</button>
                <button id="popout-close-btn" class="popout-control-btn">√ó</button>
            </div>
        </div>
        <div class="popout-content" id="popout-content">
            <div class="popout-progress-container">
                <svg id="popout-progress-ring" width="80" height="80">
                    <circle cx="40" cy="40" r="35" stroke="#f0f0f0" stroke-width="6" fill="none"/>
                    <circle id="popout-progress-bar" cx="40" cy="40" r="35" stroke="#43e97b" stroke-width="6" 
                            fill="none" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s;"/>
                </svg>
                <div class="popout-timer-display">
                    <div id="popout-timer-time">25:00</div>
                    <div id="popout-timer-mode">Work</div>
                </div>
            </div>
            <div class="popout-task-info" id="popout-task-info" style="display:none;">
                <span id="popout-task-name">No task selected</span>
            </div>
            <div class="popout-buttons">
                <button id="popout-start-btn" class="popout-btn primary">‚ñ∂</button>
                <button id="popout-pause-btn" class="popout-btn secondary">‚è∏</button>
                <button id="popout-reset-btn" class="popout-btn danger">‚èπ</button>
                <button id="popout-games-btn" class="popout-btn games disabled" title="Games are only available during breaks">üéÆ</button>
                <button id="popout-expand-btn" class="popout-btn expand">‚õ∂</button>
            </div>
            <div class="popout-cycle-info">
                <span id="popout-cycle-text">Pomodoro 1 of 4</span>
            </div>
        </div>
        <div class="popout-minimized" id="popout-minimized" style="display:none;">
            <div id="popout-mini-time">25:00</div>
            <div id="popout-mini-mode">Work</div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='javascript/popout-timer.js') }}"></script>
    {% endif %}
    
    <!-- Mobile menu toggle functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            // Set active navigation state based on current page
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
            
            if (mobileMenuToggle && sidebar) {
                // Create overlay for mobile
                const overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                document.body.appendChild(overlay);
                
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('active');
                    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
                });
                
                // Close sidebar when clicking on overlay
                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                // Close sidebar when clicking on a link
                const sidebarLinks = sidebar.querySelectorAll('a');
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
                
                // Close sidebar when pressing Escape key
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && sidebar.classList.contains('open')) {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }
        });

        // CSRF Token helper function
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // Add CSRF token to all forms automatically
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form:not([data-no-csrf])');
            forms.forEach(function(form) {
                if (!form.querySelector('input[name="csrf_token"]')) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = getCSRFToken();
                    form.appendChild(csrfInput);
                }
            });
        });
    </script>
</body>
</html>