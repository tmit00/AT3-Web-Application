{% extends "base.html" %}

{% block title %}AI Chatbot{% endblock %}

{% block content %}
<div class="chatbot-container">
    <div class="chatbot-header">
        <h1>ðŸ¤– AI Assistant</h1>
        <p>Ask me anything! I'm here to help with your questions and tasks.</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span>Status:</span>
            <span>Online</span>
        </div>
        <div class="status-item">
            <span>Last Activity:</span>
            <span>5 minutes ago</span>
        </div>
    </div>
    
    <div class="quick-actions">
        <button class="quick-action-btn">New Chat</button>
        <button class="quick-action-btn">Settings</button>
        <button class="quick-action-btn">Help</button>
    </div>
    
    <div class="chat-window">
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                ðŸ‘‹ Hello! I'm your AI assistant. How can I help you today?
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea 
                id="messageInput" 
                class="chat-input" 
                placeholder="Type your message here..."
                rows="1"
            ></textarea>
            <button id="sendButton" class="send-button" disabled>
                âž¤
            </button>
            <button id="clearButton" class="clear-button">
                Clear Chat
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const clearButton = document.getElementById('clearButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const statusBar = document.querySelector('.status-bar');
    const quickActions = document.querySelector('.quick-actions');

    let lastActivityTime = new Date();
    let messageCount = 0;

    // Update status bar
    function updateStatus() {
        const now = new Date();
        const timeDiff = Math.floor((now - lastActivityTime) / 60000); // minutes
        const statusText = timeDiff < 1 ? 'Just now' : `${timeDiff} minute${timeDiff > 1 ? 's' : ''} ago`;
        
        const lastActivitySpan = statusBar.querySelector('.status-item:last-child span:last-child');
        if (lastActivitySpan) {
            lastActivitySpan.textContent = statusText;
        }
    }

    // Update status every minute
    setInterval(updateStatus, 60000);

    // Quick action handlers
    quickActions.addEventListener('click', function(e) {
        if (e.target.classList.contains('quick-action-btn')) {
            const action = e.target.textContent.toLowerCase();
            
            switch(action) {
                case 'new chat':
                    if (confirm('Start a new conversation? This will clear the current chat history.')) {
                        clearChat();
                    }
                    break;
                case 'settings':
                    // Could open a settings modal in the future
                    alert('Settings feature coming soon!');
                    break;
                case 'help':
                    showHelp();
                    break;
            }
        }
    });

    function showHelp() {
        const helpText = `ðŸ¤– AI Assistant Help

Task Management:
â€¢ "create task Buy groceries" - Create a new task
â€¢ "complete task Buy groceries" - Mark task as complete
â€¢ "delete task Buy groceries" - Delete a task
â€¢ "show my tasks" - List all tasks
â€¢ "show overdue tasks" - Show overdue tasks

Smart Features:
â€¢ "show analytics" - View task statistics
â€¢ "get suggestions" - Get smart recommendations
â€¢ "session summary" - See what we accomplished

Natural Language:
â€¢ "remind me to call mom tomorrow"
â€¢ "i need to study for exam next week"
â€¢ "mark task 5 as complete"

Tips:
â€¢ Use natural language - the AI understands context
â€¢ Add descriptions and dates to tasks
â€¢ Ask for help anytime!`;
        
        addMessage(helpText, 'bot');
    }

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        
        // Enable/disable send button based on input
        sendButton.disabled = !this.value.trim();
        
        // Update last activity
        lastActivityTime = new Date();
    });

    // Send message on Enter (but allow Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Send button click
    sendButton.addEventListener('click', sendMessage);

    // Clear button click
    clearButton.addEventListener('click', clearChat);

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Update activity and message count
        lastActivityTime = new Date();
        messageCount++;

        // Add user message to chat
        addMessage(message, 'user');
        
        // Clear input and reset height
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendButton.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        // Send message to server
        fetch('/chatbot/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            if (data.error) {
                addMessage('Sorry, I encountered an error: ' + data.error, 'bot');
            } else {
                addMessage(data.response, 'bot', data.is_truncated, data.full_response);
            }
        })
        .catch(error => {
            hideTypingIndicator();
            addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            console.error('Error:', error);
        });
    }

    function addMessage(text, sender, isTruncated = false, fullText = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
        
        const content = document.createElement('div');
        content.className = 'message-content';
        
        // Create the main text content
        const textContent = document.createElement('div');
        textContent.className = 'message-text';
        textContent.textContent = text;
        content.appendChild(textContent);
        
        // Add expand button if message is truncated
        if (isTruncated && fullText) {
            const expandButton = document.createElement('div');
            expandButton.className = 'expand-button';
            expandButton.innerHTML = 'âŒ„'; // Down chevron for expand
            expandButton.title = 'Click to expand';
            
            const fullTextDiv = document.createElement('div');
            fullTextDiv.className = 'full-text';
            fullTextDiv.style.display = 'none';
            fullTextDiv.textContent = fullText;
            
            expandButton.addEventListener('click', function() {
                if (fullTextDiv.style.display === 'none') {
                    fullTextDiv.style.display = 'block';
                    textContent.style.display = 'none';
                    expandButton.innerHTML = 'âŒƒ'; // Up chevron for collapse
                    expandButton.title = 'Click to collapse';
                } else {
                    fullTextDiv.style.display = 'none';
                    textContent.style.display = 'block';
                    expandButton.innerHTML = 'âŒ„'; // Down chevron for expand
                    expandButton.title = 'Click to expand';
                }
            });
            
            content.appendChild(fullTextDiv);
            content.appendChild(expandButton);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    function clearChat() {
        if (confirm('Are you sure you want to clear the chat history?')) {
            fetch('/chatbot/clear_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    chatMessages.innerHTML = '<div class="welcome-message">ðŸ‘‹ Hello! I\'m your AI assistant. How can I help you today?</div>';
                    messageCount = 0;
                    lastActivityTime = new Date();
                }
            })
            .catch(error => {
                console.error('Error clearing chat:', error);
            });
        }
    }

    // Focus on input when page loads
    messageInput.focus();
    
    // Show welcome message with tips
    setTimeout(() => {
        if (chatMessages.children.length === 1) { // Only welcome message
            addMessage('ðŸ’¡ Quick Tips:\nâ€¢ Try "create task Buy groceries" to add a task\nâ€¢ Ask "show my tasks" to see your task list\nâ€¢ Say "get suggestions" for smart recommendations\nâ€¢ Type "help" for more commands', 'bot');
        }
    }, 1000);
});
</script>
{% endblock %}