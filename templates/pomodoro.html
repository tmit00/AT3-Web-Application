{% set hide_mini_timer = True %}
{% extends "base.html" %}

{% block title %}FocusFlow - Pomodoro Timer{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pomodoro.css') }}">

<div class="pomodoro-container">
    <h1>Pomodoro Timer</h1>
    
    <div class="pomodoro-center-column">
        <div class="pomodoro-timer-ring-container">
            <svg id="progress-ring" width="170" height="170">
                <defs>
                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle
                    id="progress-ring-bg"
                    cx="85" cy="85" r="75"
                    stroke="#e2e8f0"
                    stroke-width="12"
                    fill="none"
                />
                <circle
                    id="progress-ring-bar"
                    cx="85" cy="85" r="75"
                    stroke="url(#progressGradient)"
                    stroke-width="12"
                    fill="none"
                    stroke-linecap="round"
                    style="transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);"
                />
            </svg>
            <div id="timer" class="pomodoro-timer-display"></div>
        </div>
    </div>
    
    <div id="session-label" class="pomodoro-session-label">Work Session</div>
    
    <div class="task-selection">
        <label for="pomodoro-task-select">Working on:</label>
        <select id="pomodoro-task-select">
            <option value="">Select a task...</option>
        </select>
    </div>
    
    <div class="pomodoro-btn-row">
        <button class="pomodoro-btn" onclick="startTimer()">Start</button>
        <button class="pomodoro-btn" id="pause-btn" onclick="pauseTimer()">Pause</button>
        <button class="pomodoro-btn reset" onclick="resetTimer()">Reset</button>
        <button id="settings-btn" class="pomodoro-btn" title="Settings">‚öôÔ∏è</button>
        <a href="{{ url_for('todo_routes.pomodoro_games') }}" class="pomodoro-btn" id="games-btn" title="Games are only available during breaks">üéÆ Games</a>
    </div>
    
    <div class="pomodoro-cycle-info">
        <span id="cycle-info">Pomodoro 1 of 4</span>
    </div>
</div>

<!-- Settings Modal -->
<div id="pomodoro-settings-modal" class="pomodoro-modal">
    <div class="pomodoro-modal-content">
        <span class="pomodoro-close" id="close-settings">&times;</span>
        <h2>Pomodoro Settings</h2>
        <form id="pomodoro-settings-form">
            <label for="work-duration">Work Duration (minutes)</label>
            <input type="number" min="1" max="90" id="work-duration" required value="25">
            
            <label for="short-break-duration">Short Break (minutes)</label>
            <input type="number" min="1" max="30" id="short-break-duration" required value="5">
            
            <label for="long-break-duration">Long Break (minutes)</label>
            <input type="number" min="1" max="60" id="long-break-duration" required value="15">
            
            <label for="cycles-before-long">Pomodoros before Long Break</label>
            <input type="number" min="1" max="10" id="cycles-before-long" required value="4">
            
            <label for="sound-select">Sound Notification</label>
            <select id="sound-select">
                <option value="bell">Bell</option>
                <option value="chime">Chime</option>
                <option value="beep">Beep</option>
                <option value="none">None</option>
            </select>
            
            <div class="modal-buttons">
                <button type="submit" class="pomodoro-btn">Save Settings</button>
                <button type="button" class="pomodoro-btn reset" id="default-settings-btn">Reset to Default</button>
            </div>
        </form>
    </div>
</div>

<!-- Audio elements for sounds -->
<audio id="sound-bell" src="{{ url_for('static', filename='audio/bell-notification-337658.mp3') }}"></audio>
<audio id="sound-chime" src="{{ url_for('static', filename='audio/new-notification-03-323602.mp3') }}"></audio>
<audio id="sound-beep" src="{{ url_for('static', filename='audio/notification-beep-229154.mp3') }}"></audio>

<script src="{{ url_for('static', filename='javascript/pomodoro.js') }}"></script>
<script>
    // Fetch tasks for the dropdown (AJAX)
    fetch('/api/tasks')
        .then(resp => resp.json())
        .then(data => {
            const select = document.getElementById('pomodoro-task-select');
            select.innerHTML = '<option value="">Select a task...</option>';
            if (data && data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    const opt = document.createElement('option');
                    opt.value = task.id;
                    // Truncate task title if it's too long (max 40 characters)
                    const truncatedTitle = task.title.length > 40 ? task.title.substring(0, 37) + '...' : task.title;
                    opt.textContent = truncatedTitle;
                    opt.title = task.title; // Show full title on hover
                    select.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No tasks available';
                select.appendChild(opt);
            }
        })
        .catch(error => {
            console.error('Error fetching tasks:', error);
            const select = document.getElementById('pomodoro-task-select');
            select.innerHTML = '<option value="">Error loading tasks</option>';
        });

    // --- Games Button Enable/Disable Logic ---
    function updateGamesButtonState(mode) {
        const gamesBtn = document.getElementById('games-btn');
        if (!gamesBtn) return;
        
        if (mode === "shortBreak" || mode === "longBreak") {
            gamesBtn.classList.remove('disabled');
            gamesBtn.removeAttribute('aria-disabled');
            gamesBtn.setAttribute('tabindex', "0");
            gamesBtn.title = "Play a game during your break!";
            gamesBtn.style.pointerEvents = "auto";
            gamesBtn.style.opacity = "1";
        } else {
            gamesBtn.classList.add('disabled');
            gamesBtn.setAttribute('aria-disabled', "true");
            gamesBtn.setAttribute('tabindex', "-1");
            gamesBtn.title = "Games are only available during breaks";
            gamesBtn.style.pointerEvents = "none";
            gamesBtn.style.opacity = "0.5";
        }
        
        // Also update popout timer games button if it exists
        if (typeof window.updatePopoutGamesButtonState === 'function') {
            window.updatePopoutGamesButtonState(mode);
        }
    }
    
    // Initial state
    document.addEventListener("DOMContentLoaded", function() {
        // Try to get mode from localStorage
        let mode = "work";
        try {
            const state = JSON.parse(localStorage.getItem('pomodoroTimerState'));
            if (state && state.mode) mode = state.mode;
        } catch {}
        updateGamesButtonState(mode);
    });
</script>
{% endblock %}