{% set hide_mini_timer = True %}
{% extends "base.html" %}

{% block title %}Pomodoro Timer{% endblock %}

{% block content %}
<div class="pomodoro-container">
    <h1>Pomodoro Timer</h1>
    <div class="pomodoro-center-column">
        <div class="pomodoro-timer-ring-container">
            <svg id="progress-ring" width="170" height="170">
                <circle
                    id="progress-ring-bg"
                    cx="85" cy="85" r="75"
                    stroke="#f0f0f0"
                    stroke-width="12"
                    fill="none"
                />
                <circle
                    id="progress-ring-bar"
                    cx="85" cy="85" r="75"
                    stroke="#43e97b"
                    stroke-width="12"
                    fill="none"
                    stroke-linecap="round"
                    style="transition: stroke-dashoffset 0.5s;"
                />
            </svg>
            <div id="timer" class="pomodoro-timer-display"></div>
        </div>
    </div>
    <div id="session-label" class="pomodoro-session-label">Work</div>
    <div style="margin: 18px 0 10px 0; text-align: center;">
        <label for="pomodoro-task-select" style="font-weight:600;">Working on:</label>
        <select id="pomodoro-task-select" style="margin-left:8px; padding:6px 10px; border-radius:6px;"></select>
    </div>
    <div class="pomodoro-btn-row">
        <button class="pomodoro-btn" onclick="startTimer()">Start</button>
        <button class="pomodoro-btn" id="pause-btn" onclick="pauseTimer()">Pause</button>
        <button class="pomodoro-btn reset" onclick="resetTimer()">Reset</button>
        <button id="settings-btn" class="pomodoro-btn">&#9881;</button>
        <a href="{{ url_for('todo_routes.pomodoro_games') }}" class="pomodoro-btn" id="games-btn" style="background:linear-gradient(135deg,#43e97b 0%,#4f8cff 100%);" tabindex="-1" aria-disabled="true" title="Games are only available during breaks">Games</a>
    </div>
    <div class="pomodoro-cycle-info">
        <span id="cycle-info">Pomodoro 1 of 4</span>
    </div>
</div>

<!-- Settings Modal -->
<div id="pomodoro-settings-modal" class="pomodoro-modal">
    <div class="pomodoro-modal-content">
        <span class="pomodoro-close" id="close-settings">&times;</span>
        <h2>Pomodoro Settings</h2>
        <form id="pomodoro-settings-form">
            <label>Work Duration (minutes): <input type="number" min="1" max="90" id="work-duration" required></label><br>
            <label>Short Break (minutes): <input type="number" min="1" max="30" id="short-break-duration" required></label><br>
            <label>Long Break (minutes): <input type="number" min="1" max="60" id="long-break-duration" required></label><br>
            <label>Pomodoros before Long Break: <input type="number" min="1" max="10" id="cycles-before-long" required></label><br>
            <label>Sound:
                <select id="sound-select">
                    <option value="bell">Bell</option>
                    <option value="chime">Chime</option>
                    <option value="beep">Beep</option>
                    <option value="none">None</option>
                </select>
            </label>
            <br>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit" class="pomodoro-btn">Save</button>
                <button type="button" class="pomodoro-btn reset" id="default-settings-btn" style="background:linear-gradient(135deg,#bdbdbd 0%,#757575 100%);">Default</button>
            </div>
        </form>
    </div>
</div>

<!-- Audio elements for sounds -->
<audio id="sound-bell" src="{{ url_for('static', filename='audio/bell-notification-337658.mp3') }}"></audio>
<audio id="sound-chime" src="{{ url_for('static', filename='audio/new-notification-03-323602.mp3') }}"></audio>
<audio id="sound-beep" src="{{ url_for('static', filename='audio/notification-beep-229154.mp3') }}"></audio>

<script src="{{ url_for('static', filename='javascript/pomodoro.js') }}"></script>
<script>
    // Fetch tasks for the dropdown (AJAX)
    fetch('/api/tasks')
        .then(resp => resp.json())
        .then(data => {
            const select = document.getElementById('pomodoro-task-select');
            select.innerHTML = '';
            if (data && data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    const opt = document.createElement('option');
                    opt.value = task.id;
                    opt.textContent = task.title;
                    select.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No tasks available';
                select.appendChild(opt);
            }
        });

    // --- Games Button Enable/Disable Logic ---
    function updateGamesButtonState(mode) {
        const gamesBtn = document.getElementById('games-btn');
        if (!gamesBtn) return;
        if (mode === "shortBreak" || mode === "longBreak") {
            gamesBtn.classList.remove('disabled');
            gamesBtn.removeAttribute('aria-disabled');
            gamesBtn.setAttribute('tabindex', "0");
            gamesBtn.title = "Play a game during your break!";
            gamesBtn.style.pointerEvents = "auto";
            gamesBtn.style.opacity = "1";
        } else {
            gamesBtn.classList.add('disabled');
            gamesBtn.setAttribute('aria-disabled', "true");
            gamesBtn.setAttribute('tabindex', "-1");
            gamesBtn.title = "Games are only available during breaks";
            gamesBtn.style.pointerEvents = "none";
            gamesBtn.style.opacity = "0.5";
        }
        
        // Also update popout timer games button if it exists
        if (typeof window.updatePopoutGamesButtonState === 'function') {
            window.updatePopoutGamesButtonState(mode);
        }
    }
    // Initial state
    document.addEventListener("DOMContentLoaded", function() {
        // Try to get mode from localStorage
        let mode = "work";
        try {
            const state = JSON.parse(localStorage.getItem('pomodoroTimerState'));
            if (state && state.mode) mode = state.mode;
        } catch {}
        updateGamesButtonState(mode);
    });
</script>
{% endblock %}